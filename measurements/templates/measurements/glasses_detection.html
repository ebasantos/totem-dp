{% extends 'measurements/base.html' %}

{% block title %}Detectar Óculos - Totem DP{% endblock %}

{% block extra_head %}
<style>
    .main-container {
        display: flex;
        min-height: 100vh;
    }
    
    .sidebar {
        width: 250px;
        background-color: #f8f9fa;
        padding: 1rem;
    }
    
    .main-content {
        flex: 1;
        padding: 2rem;
        background-color: white;
    }
    
    .video-container {
        width: 100%;
        max-width: 640px;
        margin: 0 auto;
        position: relative;
        background-color: #f0f0f0;
        border-radius: 8px;
        overflow: hidden;
    }
    
    .face-guide {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 200px;
        height: 200px;
        border: 2px solid rgba(255, 255, 255, 0.5);
        border-radius: 50%;
    }
    
    .loading {
        display: none;
    }
    
    .results {
        display: none;
    }
    
    .error {
        display: none;
        color: red;
    }
</style>
{% endblock %}

{% block content %}
<div class="main-container">
    <div class="sidebar">
        <h2 class="text-xl font-bold mb-4">Menu</h2>
        <ul>
            <li class="mb-2">
                <a href="/" class="text-blue-600 hover:text-blue-800">
                    <i class="fas fa-home mr-2"></i>Home
                </a>
            </li>
            <li class="mb-2">
                <a href="/measurements/measure" class="text-blue-600 hover:text-blue-800">
                    <i class="fas fa-ruler mr-2"></i>Medir DNP
                </a>
            </li>
            <li class="mb-2">
                <a href="/measurements/frame_suggestion" class="text-blue-600 hover:text-blue-800">
                    <i class="fas fa-glasses mr-2"></i>Sugerir Armações
                </a>
            </li>
            <li class="mb-2">
                <a href="/measurements/glasses_detection" class="text-blue-600 hover:text-blue-800">
                    <i class="fas fa-search mr-2"></i>Detectar Óculos
                </a>
            </li>
        </ul>
    </div>
    
    <div class="main-content">
        <h1 class="text-2xl font-bold mb-6">Detecção de Óculos</h1>
        
        <div class="bg-yellow-50 p-4 rounded-lg mb-6">
            <h2 class="text-lg font-semibold mb-2">Instruções:</h2>
            <ol class="list-decimal list-inside space-y-2">
                <li>Posicione seu rosto dentro do círculo guia</li>
                <li>Certifique-se de que o rosto está bem iluminado</li>
                <li>Se estiver usando óculos, ajuste-os para que fiquem retos</li>
                <li>Clique em "Capturar Imagem" para iniciar a detecção</li>
            </ol>
        </div>
        
        <div class="video-container">
            <video id="video" autoplay playsinline></video>
            <div class="face-guide"></div>
            <div id="detection-status" class="absolute top-4 left-4 bg-black bg-opacity-50 text-white px-2 py-1 rounded hidden">
                Aguardando detecção...
            </div>
        </div>
        
        <div class="mt-4 text-center">
            <button id="capture" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                <i class="fas fa-camera mr-2"></i>Capturar Imagem
            </button>
        </div>
        
        <div class="loading mt-4 text-center">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p class="mt-2">Analisando imagem...</p>
        </div>
        
        <div id="results" class="hidden">
            <div class="bg-white p-4 rounded-lg shadow">
                <h3 class="text-lg font-semibold mb-2">Resultado da Detecção</h3>
                <div id="detectionResult" class="mb-4"></div>
                <div id="markedImage" class="mb-4"></div>
                <div id="distanceResult" class="mb-4"></div>
                <div id="details" class="text-sm text-gray-600"></div>
            </div>
        </div>
        
        <div class="error mt-4">
            <p id="error-message"></p>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const video = document.getElementById('video');
    const captureButton = document.getElementById('capture');
    const loading = document.querySelector('.loading');
    const results = document.getElementById('results');
    const error = document.querySelector('.error');
    const errorMessage = document.getElementById('error-message');
    const detectionStatus = document.getElementById('detection-status');
    
    // Solicitar acesso à câmera
    navigator.mediaDevices.getUserMedia({ 
        video: { 
            facingMode: 'user',
            width: { ideal: 1280 },
            height: { ideal: 720 }
        } 
    })
    .then(stream => {
        video.srcObject = stream;
        video.style.transform = 'scaleX(-1)'; // Espelhar a imagem horizontalmente
        detectionStatus.classList.remove('hidden');
    })
    .catch(err => {
        errorMessage.textContent = 'Erro ao acessar a câmera: ' + err.message;
        error.style.display = 'block';
    });
    
    // Capturar imagem
    captureButton.addEventListener('click', function() {
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        
        // Espelhar a imagem no canvas também
        ctx.translate(canvas.width, 0);
        ctx.scale(-1, 1);
        ctx.drawImage(video, 0, 0);
        
        // Obter a imagem em formato JPEG com qualidade 0.8
        const imageData = canvas.toDataURL('image/jpeg', 0.8);
        
        // Mostrar loading
        loading.style.display = 'block';
        results.classList.add('hidden');
        error.style.display = 'none';
        detectionStatus.classList.add('hidden');
        
        // Enviar para o backend
        fetch('/api/glasses/detect/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                image: imageData
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Erro na requisição: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            loading.style.display = 'none';
            if (data.success) {
                document.getElementById('detectionResult').innerHTML = `
                    <p class="text-lg ${data.has_glasses ? 'text-green-600' : 'text-red-600'}">
                        ${data.has_glasses ? 'Óculos detectados' : 'Nenhum óculos detectado'}
                    </p>
                    <p class="text-sm text-gray-600">Confiança: ${data.confidence}%</p>
                    ${data.has_glasses && data.confidence < 70 ? 
                        '<p class="text-yellow-600 mt-2">Confiança muito baixa para medir a distância. Por favor, ajuste a posição dos óculos.</p>' : 
                        ''}
                `;
                
                if (data.marked_image) {
                    document.getElementById('markedImage').innerHTML = `
                        <img src="data:image/jpeg;base64,${data.marked_image}" 
                             alt="Imagem com marcações" 
                             class="max-w-full h-auto rounded-lg shadow">
                    `;
                }
                
                if (data.pupil_to_frame_distance !== null) {
                    document.getElementById('distanceResult').innerHTML = `
                        <p class="text-lg font-semibold">
                            Distância pupila-base: ${data.pupil_to_frame_distance}mm
                        </p>
                    `;
                } else if (data.has_glasses && data.confidence >= 70) {
                    document.getElementById('distanceResult').innerHTML = `
                        <p class="text-yellow-600">
                            Não foi possível medir a distância. Por favor, ajuste a posição dos óculos.
                        </p>
                    `;
                }
                
                document.getElementById('details').innerHTML = `
                    <p>Detecções de óculos: ${data.details.glasses_detections}</p>
                    <p>Olhos detectados: ${data.details.eyes_detected}</p>
                    <p>Densidade de bordas: ${data.details.edge_density}%</p>
                `;
                
                results.classList.remove('hidden');
            } else {
                errorMessage.textContent = data.error || 'Erro ao processar a imagem';
                error.style.display = 'block';
            }
        })
        .catch(err => {
            loading.style.display = 'none';
            errorMessage.textContent = 'Erro ao enviar a imagem: ' + err.message;
            error.style.display = 'block';
        });
    });
    
    // Função auxiliar para obter o token CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %} 